# カバレッジ向上難易度分析

## 📋 概要

このドキュメントでは、py-stockプロジェクトにおけるテストカバレッジ向上の難易度を詳細に分析し、難易度を上げている要因を特定・整理します。

**分析日時**: 2025-05-31  
**対象カバレッジ**: 70.80%  
**分析対象**: srcディレクトリ全42ファイル

## 🏷️ 難易度分類基準

### 🟢 Easy（簡単） - 80%以上
- **定義**: 現在のカバレッジが80%以上
- **特徴**: 既に大部分がテストされており、残りの未カバー部分は比較的簡単に対応可能
- **対象ファイル数**: 28ファイル
- **向上戦略**: エッジケース、エラーハンドリング、境界値テストの追加

### 🟡 Medium（中程度） - 60-79%
- **定義**: 現在のカバレッジが60-79%
- **特徴**: 基本機能はテストされているが、設定パターンや条件分岐の一部が未テスト
- **対象ファイル数**: 7ファイル
- **向上戦略**: パラメータ化テスト、モック活用、設定値の多様化

### 🟠 Hard（困難） - 40-59%
- **定義**: 現在のカバレッジが40-59%
- **特徴**: 複雑な依存関係や設定により、テストが困難
- **対象ファイル数**: 0ファイル
- **向上戦略**: アーキテクチャ見直し、依存関係注入、リファクタリング

### 🔴 Very Hard（非常に困難） - 40%未満
- **定義**: 現在のカバレッジが40%未満
- **特徴**: 複雑な外部依存、レガシーコード、設計上の問題
- **対象ファイル数**: 0ファイル
- **向上戦略**: 大規模リファクタリング、設計見直し

### 📚 Examples（特殊） - examplesディレクトリ
- **定義**: 教育・デモ用途のファイル
- **特徴**: 低カバレッジだが、用途上許容される
- **対象ファイル数**: 7ファイル
- **向上戦略**: 基本動作確認テストのみ実装

## 📊 詳細分析

### Easy分類の詳細分析

**高カバレッジファイル（90%以上）**
- `data_validator.py` (94.34%)
- `indicators.py` (95.74%)
- `symbol_manager.py` (99.45%)
- `trade_history_manager.py` (90.07%)
- `tax_calculator.py` (90.22%)
- `stock_data_collector.py` (90.00%)

これらのファイルは設計が良く、テスト可能性が高い特徴があります。

**向上余地のあるファイル（80-89%）**
主な未カバー要因：
1. **エラーハンドリング**: 例外処理ブロック
2. **ログ出力**: デバッグレベルのログ
3. **設定値検証**: 無効な設定値に対する処理
4. **ファイルI/O例外**: ディスク容量不足、権限エラー等

### Medium分類の詳細分析

**対象ファイルと主要課題**

1. **`settings.py` (74.31%)**
   - **課題**: 設定ファイル読み込みの多様なパターン
   - **未カバー要因**: デフォルト値設定、環境変数フォールバック
   - **対策**: 設定パターンのパラメータ化テスト

2. **`backup_manager.py` (77.89%)**
   - **課題**: ファイルシステム操作、圧縮処理
   - **未カバー要因**: ディスク容量不足、権限エラー、圧縮失敗
   - **対策**: ファイルシステムのモック化

3. **`watchlist_storage.py` (73.06%)**
   - **課題**: データベース操作、トランザクション管理
   - **未カバー要因**: DB接続エラー、コミット失敗
   - **対策**: DB操作のモック化

4. **`improvement_suggestions.py` (72.07%)**
   - **課題**: 機械学習モデル、複雑な分析ロジック
   - **未カバー要因**: モデル予測、統計計算の分岐
   - **対策**: 分析結果のモック化

5. **`performance_tracker.py` (66.78%)**
   - **課題**: パフォーマンス計測、時系列データ処理
   - **未カバー要因**: 時間依存処理、計算エラー
   - **対策**: 時間のモック化

6. **`tendency_analyzer.py` (66.58%)**
   - **課題**: 統計分析、パターン認識
   - **未カバー要因**: 複雑な統計計算、データ不足時の処理
   - **対策**: データパターンの標準化

7. **`fundamental_analysis.py` (77.83%)**
   - **課題**: 外部API依存、データ解析
   - **未カバー要因**: API応答エラー、データ形式の違い
   - **対策**: API応答のモック化

## 🚫 カバレッジ向上を阻害する要因

### 1. 外部依存関係
**影響レベル**: 高

**具体的要因**:
- yfinance API呼び出し
- ファイルシステム操作
- データベース接続
- 外部設定ファイル読み込み

**対策**:
```python
# API呼び出しのモック化例
@patch('yfinance.download')
def test_stock_data_collection(mock_download):
    mock_download.return_value = mock_dataframe
    result = collect_stock_data('AAPL')
    assert len(result) > 0
```

### 2. 時間依存処理
**影響レベル**: 中

**具体的要因**:
- 現在時刻を使用した処理
- 営業日判定
- タイムゾーン処理

**対策**:
```python
# 時間のモック化例
@patch('datetime.datetime')
def test_time_sensitive_function(mock_datetime):
    mock_datetime.now.return_value = datetime(2023, 1, 1, 9, 0)
    result = trading_hours_check()
    assert result == True
```

### 3. 複雑な設定依存
**影響レベル**: 中

**具体的要因**:
- 多層設定ファイル
- 環境変数依存
- 動的設定変更

**対策**:
```python
# 設定のパラメータ化テスト例
@pytest.mark.parametrize("config_type,expected", [
    ("development", True),
    ("production", False),
    ("testing", True),
])
def test_debug_mode(config_type, expected):
    config = load_config(config_type)
    assert config.debug_mode == expected
```

### 4. 計算集約的処理
**影響レベル**: 低

**具体的要因**:
- 機械学習モデル
- 統計計算
- 大量データ処理

**対策**:
- 計算結果のモック化
- 小規模テストデータの使用
- 計算ロジックの分離

### 5. エラーハンドリングの複雑さ
**影響レベル**: 中

**具体的要因**:
- 多段階エラーハンドリング
- カスタム例外
- エラー復旧処理

**対策**:
```python
# エラーハンドリングテスト例
def test_error_recovery():
    with patch('module.risky_operation') as mock_op:
        mock_op.side_effect = [ConnectionError(), "success"]
        result = retry_operation()
        assert result == "success"
        assert mock_op.call_count == 2
```

## 🎯 優先順位付け戦略

### Phase 1: 短期改善（1-2週間）
**目標**: 70.80% → 75%

1. **Easy分類の85%以上ファイル**: 100%達成
2. **エラーハンドリングテスト**: 標準パターンの追加
3. **境界値テスト**: 既存テストの拡張

### Phase 2: 中期改善（1ヶ月）
**目標**: 75% → 80%

1. **Medium分類の改善**: モック活用
2. **設定パターンテスト**: パラメータ化
3. **統合テストの追加**: コンポーネント間連携

### Phase 3: 長期改善（3ヶ月）
**目標**: 80% → 85%

1. **アーキテクチャ改善**: 依存関係の整理
2. **テスト可能性向上**: 設計リファクタリング
3. **CI/CD統合**: 自動カバレッジチェック

## 📈 効果測定指標

### 定量指標
- **全体カバレッジ率**: 週次測定
- **ファイル別カバレッジ**: 月次詳細分析
- **新規追加機能のカバレッジ**: 100%維持

### 定性指標
- **テスト実行時間**: 現状維持
- **テストの可読性**: コードレビューで評価
- **メンテナンス性**: リファクタリング頻度

## 🛠️ ツールとプロセス

### 自動化ツール
```bash
# 定期的なカバレッジチェック
uv run python docs/testing/coverage_analyzer.py

# CI/CDでの自動チェック
uv run pytest --cov=src --cov-fail-under=75
```

### レビュープロセス
1. **新機能開発時**: カバレッジ90%以上要求
2. **週次レビュー**: カバレッジ低下の早期発見
3. **月次分析**: 全体戦略の見直し

## 📝 まとめ

py-stockプロジェクトのカバレッジ向上における主要な課題は：

1. **外部依存関係の管理** - モック活用で解決可能
2. **複雑な設定処理** - パラメータ化テストで対応
3. **時間依存処理** - 時間のモック化で解決
4. **計算集約的処理** - テストデータ最適化で改善

現在70.80%という良好なカバレッジを85%まで向上させることは、段階的なアプローチにより実現可能です。特に28ファイルがEasy分類にあることは、短期間での大幅改善が期待できることを示しています。