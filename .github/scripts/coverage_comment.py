#!/usr/bin/env python3
"""
ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã«æŠ•ç¨¿ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import json
import os
import sys
import xml.etree.ElementTree as ET
from typing import Dict, List, Tuple
import requests


def load_coverage_data() -> Tuple[float, float, int, int, List[Tuple[str, float]]]:
    """ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§è¿”ã™"""
    # coverage.jsonã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    try:
        with open('coverage.json', 'r') as f:
            coverage_data = json.load(f)
    except FileNotFoundError:
        print("Error: coverage.json not found")
        sys.exit(1)
    
    # å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸
    total_coverage = coverage_data['totals']['percent_covered']
    
    # ãƒ–ãƒ©ãƒ³ãƒã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’JSONã‹ã‚‰è¨ˆç®—
    totals = coverage_data['totals']
    if totals['num_branches'] > 0:
        branch_coverage = (totals['covered_branches'] / totals['num_branches']) * 100
    else:
        branch_coverage = 100.0  # ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã—ãªã„å ´åˆã¯100%ã¨ã™ã‚‹
    
    # æœªã‚«ãƒãƒ¼è¡Œæ•°
    missing_lines = coverage_data['totals']['missing_lines']
    total_lines = coverage_data['totals']['num_statements']
    
    # é«˜ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ90%ä»¥ä¸Šï¼‰ã‚’æŠ½å‡º
    high_coverage_files = []
    for file_path, file_data in coverage_data['files'].items():
        coverage_percent = file_data['summary']['percent_covered']
        if coverage_percent >= 90.0:
            # src/ä»¥é™ã®ãƒ‘ã‚¹ã®ã¿ã‚’è¡¨ç¤º
            display_path = file_path
            if file_path.startswith('src/'):
                display_path = file_path
            high_coverage_files.append((display_path, coverage_percent))
    
    # ã‚«ãƒãƒ¬ãƒƒã‚¸é †ã«ã‚½ãƒ¼ãƒˆ
    high_coverage_files.sort(key=lambda x: x[1], reverse=True)
    
    return total_coverage, branch_coverage, missing_lines, total_lines, high_coverage_files


def generate_comment(total_coverage: float, branch_coverage: float, 
                    missing_lines: int, total_lines: int, 
                    high_coverage_files: List[Tuple[str, float]]) -> str:
    """PRã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®Markdownã‚’ç”Ÿæˆ"""
    
    # ã‚«ãƒãƒ¬ãƒƒã‚¸çŠ¶æ…‹ã®åˆ¤å®š
    coverage_status = "âœ…" if total_coverage >= 80.0 else "âŒ"
    threshold_text = "Target met" if total_coverage >= 80.0 else "Target not met"
    
    comment = f"""## ğŸ“Š Test Coverage Report

**Overall Coverage:** {total_coverage:.2f}% {coverage_status}
**Branch Coverage:** {branch_coverage:.2f}%
**Missing Lines:** {missing_lines:,}

### High Coverage Files (90%+)
"""
    
    # é«˜ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆï¼ˆæœ€å¤§10ä»¶ï¼‰
    if high_coverage_files:
        for file_path, coverage in high_coverage_files[:10]:
            comment += f"- `{file_path}`: {coverage:.2f}%\n"
        
        if len(high_coverage_files) > 10:
            comment += f"- ... and {len(high_coverage_files) - 10} more files\n"
    else:
        comment += "- No files with 90%+ coverage\n"
    
    comment += f"""
### Coverage Details
- **{threshold_text}:** {coverage_status} 80% threshold {'exceeded' if total_coverage >= 80.0 else 'not met'}
- **Total lines:** {total_lines:,}
- **Covered lines:** {total_lines - missing_lines:,}

*Coverage report generated by pytest-cov*
"""
    
    return comment


def post_pr_comment(comment: str) -> None:
    """PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹"""
    
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—
    github_token = os.environ.get('GITHUB_TOKEN')
    github_repository = os.environ.get('GITHUB_REPOSITORY')
    pr_number = os.environ.get('PR_NUMBER')
    
    if not all([github_token, github_repository, pr_number]):
        print("Error: Missing required environment variables")
        print(f"GITHUB_TOKEN: {'SET' if github_token else 'NOT SET'}")
        print(f"GITHUB_REPOSITORY: {github_repository or 'NOT SET'}")
        print(f"PR_NUMBER: {pr_number or 'NOT SET'}")
        sys.exit(1)
    
    # æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¦æ›´æ–°ã™ã‚‹ã‹æ–°è¦æŠ•ç¨¿ã™ã‚‹ã‹ã‚’åˆ¤å®š
    api_url = f"https://api.github.com/repos/{github_repository}/issues/{pr_number}/comments"
    headers = {
        'Authorization': f'token {github_token}',
        'Accept': 'application/vnd.github.v3+json'
    }
    
    # æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
    response = requests.get(api_url, headers=headers)
    if response.status_code == 200:
        comments = response.json()
        coverage_comment_id = None
        
        for comment_data in comments:
            if "ğŸ“Š Test Coverage Report" in comment_data['body']:
                coverage_comment_id = comment_data['id']
                break
        
        # æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
        if coverage_comment_id:
            update_url = f"https://api.github.com/repos/{github_repository}/issues/comments/{coverage_comment_id}"
            response = requests.patch(update_url, 
                                    headers=headers, 
                                    json={'body': comment})
            if response.status_code == 200:
                print("âœ… Coverage comment updated successfully")
                return
            else:
                print(f"âŒ Failed to update comment: {response.status_code}")
                print(response.text)
    
    # æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
    response = requests.post(api_url, 
                           headers=headers, 
                           json={'body': comment})
    
    if response.status_code == 201:
        print("âœ… Coverage comment posted successfully")
    else:
        print(f"âŒ Failed to post comment: {response.status_code}")
        print(response.text)
        sys.exit(1)


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    
    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    total_coverage, branch_coverage, missing_lines, total_lines, high_coverage_files = load_coverage_data()
    
    # ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
    comment = generate_comment(total_coverage, branch_coverage, missing_lines, total_lines, high_coverage_files)
    
    # ãƒ‡ãƒãƒƒã‚°ç”¨: ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’è¡¨ç¤º
    print("Generated comment:")
    print("=" * 50)
    print(comment)
    print("=" * 50)
    
    # PRã‚³ãƒ¡ãƒ³ãƒˆã«æŠ•ç¨¿
    post_pr_comment(comment)


if __name__ == "__main__":
    main()